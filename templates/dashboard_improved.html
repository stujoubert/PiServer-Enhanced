{% extends "layout.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card h3 {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-card .value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .stat-card .subtitle {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .chart-container {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .chart-container h2 {
        margin-bottom: 20px;
        color: #1b1d21;
        font-size: 1.3rem;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
    }

    .table-container {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
    }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .modern-table thead th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
    }

    .modern-table tbody tr {
        transition: background-color 0.2s;
    }

    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .modern-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
    }

    .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .badge-success {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background-color: #f8d7da;
        color: #721c24;
    }

    .date-picker {
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .date-picker input {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.95rem;
    }

    .date-picker button {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .date-picker button:hover {
        background: #5568d3;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        .chart-container,
        .table-container,
        .date-picker {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        .modern-table thead th {
            background: #3a3a3a;
            color: #e0e0e0;
            border-bottom-color: #4a4a4a;
        }

        .modern-table tbody tr:hover {
            background-color: #3a3a3a;
        }

        .modern-table td {
            border-bottom-color: #4a4a4a;
        }
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .stat-card .value {
            font-size: 2rem;
        }

        .chart-wrapper {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px; color: #1b1d21;">{{ T.dashboard_title or "Dashboard" }}</h1>

<!-- Date Picker -->
<div class="date-picker">
    <label for="date-select"><strong>{{ T.select_date or "Select Date" }}:</strong></label>
    <input type="date" id="date-select" value="{{ selected_date }}" 
           onchange="window.location.href='?date=' + this.value">
    <button onclick="window.location.href='?date=' + new Date().toISOString().split('T')[0]">
        {{ T.today or "Today" }}
    </button>
</div>

<!-- Daily Statistics -->
<div class="dashboard-grid">
    <div class="stat-card success">
        <h3>{{ T.present or "Present" }}</h3>
        <div class="value">{{ present }}</div>
        <div class="subtitle">{{ T.out_of or "out of" }} {{ expected }} {{ T.employees or "employees" }}</div>
    </div>

    <div class="stat-card danger">
        <h3>{{ T.absent or "Absent" }}</h3>
        <div class="value">{{ absent }}</div>
        <div class="subtitle">{{ (absent / expected * 100)|round(1) if expected > 0 else 0 }}% {{ T.of_total or "of total" }}</div>
    </div>

    <div class="stat-card warning">
        <h3>{{ T.late_arrivals or "Late Arrivals" }}</h3>
        <div class="value">{{ late }}</div>
        <div class="subtitle">{{ T.grace_period_exceeded or "Grace period exceeded" }}</div>
    </div>

    <div class="stat-card info">
        <h3>{{ T.attendance_rate or "Attendance Rate" }}</h3>
        <div class="value">{{ attendance_rate }}%</div>
        <div class="subtitle">{{ T.for_selected_date or "For selected date" }}</div>
    </div>
</div>

<!-- Charts -->
<div class="row">
    <div class="col-md-6">
        <div class="chart-container">
            <h2>{{ T.daily_overview or "Daily Overview" }}</h2>
            <div class="chart-wrapper">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h2>{{ T.attendance_breakdown or "Attendance Breakdown" }}</h2>
            <div class="chart-wrapper">
                <canvas id="breakdownChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Performance Table -->
<div class="table-container">
    <h2 style="margin-bottom: 20px;">{{ T.monthly_performance or "Monthly Performance" }} - {{ month_label }}</h2>
    
    {% if monthly %}
    <table class="modern-table">
        <thead>
            <tr>
                <th>{{ T.employee_id or "Employee ID" }}</th>
                <th>{{ T.name or "Name" }}</th>
                <th>{{ T.days_attended or "Days Attended" }}</th>
                <th>{{ T.late_count or "Late" }}</th>
                <th>{{ T.early_departures or "Early Leave" }}</th>
                <th>{{ T.missed_clockout or "Missed Clock-out" }}</th>
                <th>{{ T.attendance_rate or "Rate" }}</th>
            </tr>
        </thead>
        <tbody>
            {% for emp in monthly %}
            <tr>
                <td><strong>{{ emp.employee_id }}</strong></td>
                <td>{{ emp.name }}</td>
                <td>{{ emp.attended }}</td>
                <td>
                    {% if emp.late > 0 %}
                        <span class="badge badge-warning">{{ emp.late }}</span>
                    {% else %}
                        <span class="badge badge-success">0</span>
                    {% endif %}
                </td>
                <td>
                    {% if emp.early > 0 %}
                        <span class="badge badge-warning">{{ emp.early }}</span>
                    {% else %}
                        <span class="badge badge-success">0</span>
                    {% endif %}
                </td>
                <td>
                    {% if emp.missed > 0 %}
                        <span class="badge badge-danger">{{ emp.missed }}</span>
                    {% else %}
                        <span class="badge badge-success">0</span>
                    {% endif %}
                </td>
                <td>
                    {% if emp.rate >= 90 %}
                        <span class="badge badge-success">{{ emp.rate }}%</span>
                    {% elif emp.rate >= 70 %}
                        <span class="badge badge-warning">{{ emp.rate }}%</span>
                    {% else %}
                        <span class="badge badge-danger">{{ emp.rate }}%</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #6c757d; padding: 40px;">
        {{ T.no_data or "No attendance data available for this month" }}
    </p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Daily Overview Chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'doughnut',
    data: {
        labels: ['{{ T.present or "Present" }}', '{{ T.absent or "Absent" }}'],
        datasets: [{
            data: [{{ present }}, {{ absent }}],
            backgroundColor: [
                'rgba(17, 153, 142, 0.8)',
                'rgba(250, 112, 154, 0.8)'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 13
                    }
                }
            }
        }
    }
});

// Attendance Breakdown Chart
const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
new Chart(breakdownCtx, {
    type: 'bar',
    data: {
        labels: ['{{ T.on_time or "On Time" }}', '{{ T.late or "Late" }}', '{{ T.early_leave or "Early Leave" }}', '{{ T.missed or "Missed Clock-out" }}'],
        datasets: [{
            label: '{{ T.count or "Count" }}',
            data: [{{ present - late }}, {{ late }}, {{ early_leave }}, {{ missed }}],
            backgroundColor: [
                'rgba(56, 239, 125, 0.8)',
                'rgba(245, 87, 108, 0.8)',
                'rgba(240, 147, 251, 0.8)',
                'rgba(254, 225, 64, 0.8)'
            ],
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}
