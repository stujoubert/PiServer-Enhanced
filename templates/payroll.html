{% extends "layout.html" %}
{% block content %}

<style>
/* -------------------------
   Card
------------------------- */
.card-modern {
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    padding: 18px;
    margin-bottom: 18px;
}

/* -------------------------
   Header
------------------------- */
.payroll-header {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: space-between;
    align-items: center;
}

.payroll-header h3 {
    margin: 0;
    font-weight: 700;
    font-size: 1.25rem;
}

/* Export buttons */
.export-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

/* -------------------------
   Filters
------------------------- */
.payroll-filters {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 14px;
}

.payroll-filters label {
    font-weight: 600;
    font-size: 0.85rem;
}

@media (min-width: 768px) {
    .payroll-filters {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        align-items: end;
    }
}

/* -------------------------
   Table
------------------------- */
.table-modern thead th {
    background: #f5f6f8;
    border-bottom: 2px solid #e1e3e6;
    font-weight: 600;
    font-size: 0.8rem;
    white-space: nowrap;
    text-align: center;
}

.table-modern td {
    text-align: center;
    vertical-align: top;
    font-size: 0.85rem;
    white-space: nowrap;
}

.day-cell {
    line-height: 1.2;
}

/* Horizontal scroll wrapper */
.table-responsive-x {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* -------------------------
   Flags
------------------------- */
.flag-badge {
    display: inline-block;
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: 6px;
    background: #fdecea;
    color: #c0392b;
    font-weight: 600;
    margin: 2px 2px 0 0;
}

.flag-offday {
    background: #fff3cd;
    color: #856404;
}

.flags-wrap {
    margin-top: 4px;
}

/* Small screens */
@media (max-width: 576px) {
    .payroll-header h3 {
        font-size: 1.15rem;
    }
}
</style>

<!-- ========================= -->
<!-- HEADER + EXPORTS          -->
<!-- ========================= -->
<div class="card-modern">

    <div class="payroll-header">
        <h3>{{ T.payroll_title }}</h3>

        <div class="export-actions">

            <form method="get"
                  action="{{ url_for('payroll.payroll_export') }}"
                  class="m-0">

                <input type="hidden" name="week" value="{{ selected_week }}">
                <input type="hidden" name="week_type" value="{{ week_type }}">
                <input type="hidden" name="user" value="{{ selected_user }}">

                <button type="submit"
                        class="btn btn-outline-success"
                        {% if not payroll_data %}disabled{% endif %}>
                    {{ T.download_excel }}
                </button>
            </form>

            <a href="{{ url_for('reports.export_fifo',
                                week=selected_week,
                                week_type=week_type) }}"
               class="btn btn-outline-primary {% if not payroll_data %}disabled{% endif %}">
                FIFO ({{ T.mode_first_last }})
            </a>

        </div>
    </div>

    <!-- ========================= -->
    <!-- FILTERS                  -->
    <!-- ========================= -->
    <form method="get" class="payroll-filters">

        <div>
            <label>{{ T.week_type }}</label>
            <select name="week_type" class="form-select" onchange="this.form.submit()">
                <option value="mon_sat" {% if week_type == "mon_sat" %}selected{% endif %}>{{ T.mon_sat }}</option>
                <option value="sat_fri" {% if week_type == "sat_fri" %}selected{% endif %}>{{ T.sat_fri }}</option>
                <option value="sun_sat" {% if week_type == "sun_sat" %}selected{% endif %}>{{ T.sun_sat }}</option>
            </select>
        </div>

        <div>
            <label>{{ T.week_prefix }}</label>
            <select name="week" class="form-select" onchange="this.form.submit()">
                {% for ws, we in week_list %}
                    <option value="{{ ws.isoformat() }}"
                        {% if ws == selected_week %}selected{% endif %}>
                        {{ ws }} → {{ we }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label>{{ T.nav_users }}</label>
            <select name="user" class="form-select" onchange="this.form.submit()">
                <option value="">{{ T.apply }}</option>
                {% for uid, uname in users %}
                    <option value="{{ uid }}"
                        {% if selected_user and (selected_user|string) == (uid|string) %}
                            selected
                        {% endif %}>
                        {{ uname }}
                    </option>
                {% endfor %}
            </select>
        </div>

    </form>

    <p class="mt-3 mb-0">
        {{ T.payroll_pdf_subtitle }}:
        <strong>{{ week_start }}</strong> → <strong>{{ week_end }}</strong>
    </p>

</div>

<!-- ========================= -->
<!-- PAYROLL TABLE             -->
<!-- ========================= -->
<div class="card-modern">

{% if payroll_data %}

{% set weekday_names = [
    T.monday, T.tuesday, T.wednesday,
    T.thursday, T.friday, T.saturday, T.sunday
] %}

<div class="table-responsive-x">
<table class="table table-modern table-bordered align-middle">

<thead>
<tr>
    <th rowspan="2">{{ T.name }}</th>
    {% for d in week_dates %}
        <th colspan="4">
            {{ weekday_names[d.weekday()] }}
            {{ "%02d"|format(d.day) }}/{{ "%02d"|format(d.month) }}
        </th>
    {% endfor %}
    <th rowspan="2">{{ T.regular_hours }}</th>
    <th rowspan="2">{{ T.overtime_hours }}</th>
    <th rowspan="2">{{ T.total_hours }}</th>
</tr>
<tr>
    {% for _ in week_dates %}
        <th>{{ T.in }}</th>
        <th>{{ T.out }}</th>
        <th>{{ T.hours }}</th>
        <th>{{ T.overtime }}</th>
    {% endfor %}
</tr>
</thead>

<tbody>
{% for emp in payroll_data %}
<tr>

<td class="text-start fw-semibold">
    {{ emp.name }}
    {% if not emp.is_active %}
        <span class="badge bg-danger ms-1">
            {{ T.inactive }}
        </span>
    {% endif %}
</td>

{% for d in week_dates %}
{% set rec = emp.days.get(d.isoformat()) %}

<td>{{ rec.in if rec else "" }}</td>
<td>{{ rec.out if rec else "" }}</td>
<td>{{ rec.hours if rec else "00:00" }}</td>

<td>
    {{ rec.ot if rec else "00:00" }}

    {% if rec and rec.flags %}
    <div class="flags-wrap">
        {% if "off_day_work" in rec.flags %}
            <span class="flag-badge flag-offday">off day</span>
        {% endif %}
        {% for f in rec.flags if f != "off_day_work" %}
            <span class="flag-badge">{{ f }}</span>
        {% endfor %}
    </div>
    {% endif %}
</td>

{% endfor %}

<td class="fw-semibold">{{ emp.total_regular }}</td>
<td class="fw-semibold">{{ emp.total_ot }}</td>
<td class="fw-bold">{{ emp.total_all }}</td>

</tr>
{% endfor %}
</tbody>

</table>
</div>

{% else %}
<p class="mb-0 text-muted">{{ T.no_data_range }}</p>
{% endif %}

</div>

{% endblock %}
